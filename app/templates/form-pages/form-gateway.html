{% extends 'index.html' %} {% block content %}

<div class="content-page">
  <div class="form-wrapper column">
    <div class="form-header column">
      <div class="row title-head-td">
        <i class="fa-solid fa-server" style="--clr: var(--clr-fourth); --icon-clr: var(--clr-second)"></i>
        <span class="title">
            {% if form.instance.pk %}
                Edit Gateway Server {{ server.name }}
            {% else %}
                Buat Gateway Server {{ server.name }} Baru
            {% endif %}
        </span>
      </div>
    </div>

    <form method="post" class="column">
      {% csrf_token %}
       <div class="column">
        <label for="{{ form.parent_choice.id_for_label }}">Source (Server / ODP)</label>
        {{ form.parent_choice }}
      </div>

      <div class="column">
        <label for="name">Name</label>
        {{ form.name }}
      </div>

      <div class="row gap-20" style="width: full;">
        <div class="column">
          <label for="lat">Latitude</label>
          {{form.lat}}
        </div>

        <div class="column">
          <label for="long">Longitude</label>
          {{form.long}}
        </div>
      </div>

      <div id="map-client" style="height: 600px"></div>

      <div class="row button-wrapper">
        <button class="success-button" type="submit">Simpan</button>
        <button
          class="warning-button no-loader"
          type="button"
          onclick="window.history.back();"
        >
          Batal
        </button>
      </div>
    </form>
  </div>
</div>

{% if success %}
<script>
Swal.fire({
  icon: 'success',
  title: 'Data berhasil disimpan!',
  text: 'Anda akan dialihkan ke halaman Server.',
  timer: 2000,
  showConfirmButton: false
}).then(() => {
  window.location.href = "{% url 'server' %}";
});
</script>
{% endif %}

{% if error_message %}
<script>
Swal.fire({
  icon: 'error',
  title: 'Gagal menyimpan!',
  text: '{{ error_message|escapejs }}',
  confirmButtonText: 'OK'
});
</script>
{% endif %}



<script>
  $(document).ready(function() {
    $('#gw-select').select2({
      placeholder: "Pilih server...",
      allowClear: true
    });
  });
</script>




<script>
  var map = L.map("map-client").setView([0, 0], 2);
  const latitude = '{{ server.lat|default:"0" }}';
  const longitude = '{{ server.long|default:"0" }}';

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "&copy; OpenStreetMap contributors",
  }).addTo(map);


   L.marker([latitude, longitude], { icon: serverIcon })
    .addTo(map)
    .bindPopup("{{server.name}}")

  var marker = L.marker([0, 0], { draggable: true }).addTo(map);

  // Update input kalau marker digeser
  marker.on("dragend", function (e) {
    var lat = e.target.getLatLng().lat;
    var lng = e.target.getLatLng().lng;
    document.getElementById("id_lat").value = lat;
    document.getElementById("id_long").value = lng;
  });

  // Minta lokasi dari browser
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      function (position) {
        var lat = position.coords.latitude;
        var lng = position.coords.longitude;

        // Pindah map & marker
        map.setView([lat, lng], 15);
        marker.setLatLng([lat, lng]);

        // Isi input form
        document.getElementById("latitude").value = lat;
        document.getElementById("longitude").value = lng;
      },
      function (error) {
        alert("Gagal mendapatkan lokasi: " + error.message);
      }
    );
  } else {
    alert("Browser tidak mendukung geolocation.");
  }
</script>




{% endblock %}
