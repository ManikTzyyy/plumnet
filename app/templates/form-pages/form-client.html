{% extends 'index.html' %} {% block content %}

<div class="content-page">
  <div class="form-wrapper column">
    <div class="form-header column">
      <div class="row title-head-td">
        <i
          class="fa-solid fa-user"
          style="--clr: var(--clr-fourth); --icon-clr: var(--clr-second)"
        ></i>
        <span class="title">{{ form.instance.pk|yesno:"Edit Pelanggan,Tambah Pelanggan Baru"}}</span>
      </div>
    </div>

    <form method="post" class="column">
      {% csrf_token %}
      <div class="column">
        <label for="profile">Paket</label>
        {{ form.id_paket }}
      </div>
      <div class="column">
        <label for="fullname">Name </label>
        {{ form.name }}
      </div>
      <div class="column">
        <label for="address">Alamat</label>
        {{ form.address }}
      </div>
      <div class="column">
        <label for="address">Email</label>
        {{ form.email }}
      </div>
      <div class="column">
        <label for="phone">No Hp </label>
        {{ form.phone }}
      </div>

      <div class="column">
        <label for="pppoeID">ID PPPoE</label>
        {{ form.pppoe }}
      </div>
      <div class="column">
        <label for="pppoePass">Password PPPoE</label>
        {{ form.password }}
      </div>
      <div class="column">
        <label for="pppoePass">Local IP</label>
        {{ form.local_ip }}
      </div>

       <div class="column">
        <label for="{{ form.gateway_choice.id_for_label }}">Source (Server / ODP)</label>
        {{ form.gateway_choice }}
      </div>

      <div class="row gap-20" style="width: full;">
        <div class="column">
          <label for="lat">Latitude</label>
          {{form.lat}}
        </div>

        <div class="column">
          <label for="long">Longitude</label>
          {{form.long}}
        </div>
      </div>

      <div id="map-client" style="height: 600px"></div>

      <div class="row button-wrapper">
        <button class="success-button" type="submit">Simpan</button>
        <button
          class="warning-button no-loader"
          type="button"
          onclick="window.history.back();"
        >
          Batal
        </button>
      </div>
    </form>
  </div>
</div>

{% if success %}
<script>
  Swal.fire({
    icon: "success",
    title: "Data berhasil disimpan!",
    text: "Anda akan dialihkan ke halaman pelanggan.",
    timer: 2000,
    showConfirmButton: false,
  }).then(() => {
    window.location.href = "{% url 'client' %}";
  });
</script>
{% endif %} {% if error_message %}
<script>
  Swal.fire({
    icon: "error",
    title: "Gagal menyimpan!",
    text: "{{ error_message|escapejs }}",
    confirmButtonText: "OK",
  });
</script>
{% endif %}

<script>
  const map = L.map("map-client").setView([0, 0], 2);
  const servers = {{servers_json|safe}}
  const gateways = {{gateways_json|safe}}

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "&copy; OpenStreetMap contributors",
  }).addTo(map);


   servers.forEach(function(server) {
        if (server.lat && server.long) {
            L.marker([server.lat, server.long], { icon: serverIcon })
             .addTo(map)
             .bindTooltip("<b>" + server.name + "</b>");
        }
    });

    gateways.forEach((item)=>{
      const itemMarker = L.marker([item.lat, item.long], { icon: odpIcon }, 
      {title: item.name})
      .addTo(map)
      .bindTooltip("<b>" + item.name + "</b>");

      L.polyline([
        [item.parent_lat, item.parent_long],
        [item.lat, item.long]
      ],{ color: "blue" }).addTo(map)
    })

  const marker = L.marker([0, 0], { draggable: true }).addTo(map);

  // Update input kalau marker digeser
  marker.on("dragend", function (e) {
    const lat = e.target.getLatLng().lat;
    const lng = e.target.getLatLng().lng;
    document.getElementById("id_lat").value = lat;
    document.getElementById("id_long").value = lng;
  });



  // Minta lokasi dari browser
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      function (position) {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;

        // Pindah map & marker
        map.setView([lat, lng], 15);
        marker.setLatLng([lat, lng]);

        // Isi input form
        document.getElementById("latitude").value = lat;
        document.getElementById("longitude").value = lng;
      },
      function (error) {
        alert("Gagal mendapatkan lokasi: " + error.message);
      }
    );
  } else {
    alert("Browser tidak mendukung geolocation.");
  }
</script>

{% endblock %}
