{% extends 'index.html' %} {% block content %}

<div class="content-page">
  <div class="form-wrapper column">
    <div class="form-header column">
      <div class="row title-head-td">
        <i
          class="fa-solid fa-user"
          style="--clr: var(--clr-fourth); --icon-clr: var(--clr-second)"
        ></i>
        <span class="title">{{ form.instance.pk|yesno:"Edit Pelanggan,Tambah Pelanggan Baru"}}</span>
      </div>
    </div>

    <form method="post" class="column">
      {% csrf_token %}
      <div class="column">
        <label for="server">Server</label>
        <select name="server" id="id_server" class="form-control" {% if form.instance.pk %}{% endif %}>
          <option value="">-- Pilih Server --</option>
            {% for server in servers %}
              <option value="{{ server.id }}" {% if server.id == server_selected %}selected{% endif %}>
                {{ server.name }}
              </option>
             
            {% endfor %}
        </select>
      </div>

      <div class="column">
        <label for="pool">IP Pool</label>
          <select name="pool" id="id_pool" class="form-control">
          <option value="">-- Pilih Pool --</option>
        </select>
      </div>
      <div class="column">
        <label for="profile">Paket</label>
          {{ form.id_paket }}
      </div>


      <div class="column">
        <label for="fullname">Name </label>
        {{ form.name }}
      </div>
      <div class="column">
        <label for="address">Alamat</label>
        {{ form.address }}
      </div>
      <div class="column">
        <label for="address">Email</label>
        {{ form.email }}
      </div>
      <div class="column">
        <label for="phone">No Hp </label>
        {{ form.phone }}
      </div>

      <div class="column">
        <label for="pppoeID">ID PPPoE</label>
        {{ form.pppoe }}
      </div>
      <div class="column">
        <label for="pppoePass">Password PPPoE</label>
        {{ form.password }}
      </div>
      

       

      <div class="row gap-20 align-start justify-center" style="width: full;">
         <div class="column">
        <label>&nbsp;</label>
        <button type="button" class="button main-button" onclick="openMapSwal()">
          Pilih Lokasi di Map
        </button>
      </div>

      <div class="column">
          <label for="lat">Latitude</label>
          {{form.lat}}
        </div>

        <div class="column">
          <label for="long">Longitude</label>
          {{form.long}}
        </div>
      </div>

     
      <div class="column">
        <label for="{{ form.gateway_choice.id_for_label }}">Source (Server / ODP)</label>
        {{ form.gateway_choice }}
      </div>

      <div class="row button-wrapper">
        <button class="success-button" type="submit">Simpan</button>
        <button
          class="warning-button no-loader"
          type="button"
          onclick="window.history.back();"
        >
          Batal
        </button>
      </div>
    </form>
  </div>
</div>

{% if success %}
<script>
  Swal.fire({
    icon: "success",
    title: "Data berhasil disimpan!",
    text: "Anda akan dialihkan ke halaman pelanggan.",
    timer: 2000,
    showConfirmButton: false,
  }).then(() => {
    window.location.href = "{% url 'client' %}";
  });
</script>
{% endif %} {% if error_message %}
<script>
  Swal.fire({
    icon: "error",
    title: "Gagal menyimpan!",
    text: "{{ error_message|escapejs }}",
    confirmButtonText: "OK",
  });
</script>
{% endif %}


<script>
function formatRupiah(angka) {
  if (!angka) return "0";
  return angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

$(document).ready(function() {
  const poolSelect = $('#id_pool');
  const paketSelect = $('#id_id_paket');
  const serverSelect = $('#id_server');

  // Inisialisasi Select2
  serverSelect.select2({ placeholder: "Pilih Server...", allowClear: true });
  poolSelect.select2({ placeholder: "Pilih IP Pool...", allowClear: true });
  paketSelect.select2({ placeholder: "Pilih Paket...", allowClear: true });

  // Data dari Django
  const isEditMode = "{{ form.instance.pk|yesno:'true,false' }}" === "true";
  const currentServerId = "{{ server_selected|default:'' }}";
  const currentPoolId = "{{ form.instance.id_paket.id_ip_pool.id|default:'' }}";
  const currentPaketId = "{{ form.instance.id_paket.id|default:'' }}";

  // Helper: Load Pools
  function loadPools(serverId, selectedPoolId = null, callback = null) {
    poolSelect.html('<option value="">-- Pilih Pool --</option>');
    if (!serverId) return;

    fetch(`/get-pools/${serverId}/`)
      .then(res => res.json())
      .then(data => {
        data.pools.forEach(pool => {
          poolSelect.append(`<option value="${pool.id}">${pool.name}</option>`);
        });

        if (selectedPoolId) {
          poolSelect.val(selectedPoolId).trigger('change.select2');
        }
        if (callback) callback();
      })
      .catch(() => {
        Swal.fire({
          icon: 'error',
          title: 'Gagal Mengambil Pool',
          text: 'Terjadi kesalahan saat mengambil data IP Pool.'
        });
      });
  }

  // Helper: Load Paket
  function loadPakets(poolId, selectedPaketId = null) {
    paketSelect.html('<option value="">Loading paket...</option>');
    if (!poolId) return;

    fetch(`/get-pakets/${poolId}/`)
      .then(res => res.json())
      .then(data => {
        paketSelect.html('<option value="">-- Pilih Paket --</option>');
        data.pakets.forEach(paket => {
          const harga = formatRupiah(paket.price);
          paketSelect.append(
            `<option value="${paket.id}">${paket.name} - Rp ${harga} - ${paket.limit}</option>`
          );
        });

        if (selectedPaketId) {
          paketSelect.val(selectedPaketId).trigger('change.select2');
        }
      })
      .catch(() => {
        Swal.fire({
          icon: 'error',
          title: 'Gagal Mengambil Paket',
          text: 'Terjadi kesalahan saat mengambil data paket.'
        });
        paketSelect.html('<option value="">-- Pilih Paket --</option>');
      });
  }

  // ==========================
  // MODE EDIT
  // ==========================
  if (isEditMode) {
    const allowServerEdit = !currentServerId; // True kalau server_selected == None/null

    // Kalau client belum punya server → biarkan pilih server
    if (allowServerEdit) {
      poolSelect.closest('.column').hide();
      paketSelect.closest('.column').hide();

      serverSelect.on('change', function() {
        const serverId = $(this).val();
        poolSelect.html('<option value="">-- Pilih Pool --</option>');
        paketSelect.html('<option value="">-- Pilih Paket --</option>');
        paketSelect.closest('.column').hide();

        if (serverId) {
          loadPools(serverId);
          poolSelect.closest('.column').fadeIn(200);
        } else {
          poolSelect.closest('.column').hide();
          paketSelect.closest('.column').hide();
        }
      });
    }

    // Kalau client sudah punya server → lock server dan langsung load data
    else {
      setTimeout(() => {
        serverSelect.val(currentServerId).trigger('change.select2');
        serverSelect.prop('disabled', true); // dikunci

        loadPools(currentServerId, currentPoolId, () => {
          if (currentPoolId) {
            loadPakets(currentPoolId, currentPaketId);
          }
        });

        poolSelect.closest('.column').show();
        paketSelect.closest('.column').show();
      }, 200);
    }
  }

  // ==========================
  // MODE TAMBAH
  // ==========================
  else {
    poolSelect.closest('.column').hide();
    paketSelect.closest('.column').hide();

    serverSelect.on('change', function() {
      const serverId = $(this).val();
      poolSelect.html('<option value="">-- Pilih Pool --</option>');
      paketSelect.html('<option value="">-- Pilih Paket --</option>');
      paketSelect.closest('.column').hide();

      if (serverId) {
        loadPools(serverId);
        poolSelect.closest('.column').fadeIn(200);
      } else {
        poolSelect.closest('.column').hide();
        paketSelect.closest('.column').hide();
      }
    });
  }

  // ==========================
  // EVENT: Ganti Pool
  // ==========================
  poolSelect.on('change', function() {
    const poolId = $(this).val();
    if (poolId) {
      loadPakets(poolId);
      paketSelect.closest('.column').fadeIn(200);
    } else {
      paketSelect.closest('.column').hide();
      paketSelect.html('<option value="">-- Pilih Paket --</option>');
    }
  });
});
</script>






<script>
// fungsi buat generate password random
function generatePassword(length = 10) {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  let pass = "";
  for (let i = 0; i < length; i++) {
    pass += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return pass;
}

// ambil elemen input
const nameInput = document.getElementById("id_name");       // dari form.name
const pppoeInput = document.getElementById("id_pppoe");     // dari form.pppoe
const passwordInput = document.getElementById("id_password"); // dari form.password

// generate otomatis PPPoE saat user isi nama
nameInput.addEventListener("input", () => {
  let base = nameInput.value.trim().replace(/\s+/g, "").toLowerCase();
  if (base.length > 0) {
    // tambahin random 3 digit biar unik
    const rand = Math.floor(Math.random() * 1000);
    pppoeInput.value = base + rand;
  } else {
    pppoeInput.value = "";
  }
});

// generate password otomatis saat pertama kali user isi nama
nameInput.addEventListener("blur", () => {
  if (!passwordInput.value) {
    passwordInput.value = generatePassword(10);
  }
});
</script>


<script>
function openMapSwal() {
  Swal.fire({
    title: 'Pilih Lokasi di Map',
    html: '<div id="map-client" style="height:500px; width:100%;"></div>',
    width: '80%',
    didOpen: () => {
      const currentLat = parseFloat(document.getElementById("id_lat").value) || 0;
      const currentLng = parseFloat(document.getElementById("id_long").value) || 0;
      const servers = {{servers_json|safe}}
      const gateways = {{gateways_json|safe}}

      // fungsi hitung jarak (haversine)
      function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371000;
        const toRad = (deg) => deg * Math.PI / 180;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
      }

      // update dropdown gateway_choice
      function updateGatewayChoices(lat, lng, showPopup=false) {
        let distances = gateways.map((gw) => {
          return {
            id: gw.id,
            name: gw.name,
            distance: getDistance(lat, lng, parseFloat(gw.lat), parseFloat(gw.long))
          };
        });

        distances.sort((a, b) => a.distance - b.distance);

        const select = document.getElementById("id_gateway_choice");
        if (select) {
          select.innerHTML = "";
          distances.forEach((gw) => {
            const opt = document.createElement("option");
            opt.value = gw.id;
            opt.text = `${gw.name} (${gw.distance.toFixed(1)} m)`;
            select.appendChild(opt);
          });
        }

        // popup rekomendasi hanya kalau user geser marker
        if (showPopup && distances.length > 0) {
          Swal.fire({
            icon: "info",
            title: "Rekomendasi Gateway Terdekat",
            text: `${distances[0].name} (${distances[0].distance.toFixed(1)} m)`,
            timer: 2000,
            showConfirmButton: false
          });
        }
      }

      const map = L.map("map-client").setView([currentLat, currentLng], 15);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      const marker = L.marker([currentLat, currentLng], { draggable: true }).addTo(map);

      marker.on("dragend", function (e) {
        const lat = e.target.getLatLng().lat;
        const lng = e.target.getLatLng().lng;
        document.getElementById("id_lat").value = lat;
        document.getElementById("id_long").value = lng;
        updateGatewayChoices(lat, lng, true); // popup hanya di drag
      });

      setTimeout(() => { map.invalidateSize(); }, 200);

      // auto geolocation
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          function (position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;

            map.setView([lat, lng], 15);
            marker.setLatLng([lat, lng]);

            document.getElementById("id_lat").value = lat;
            document.getElementById("id_long").value = lng;

            updateGatewayChoices(lat, lng, false); // tanpa popup
          },
          function (error) {
            alert("Gagal mendapatkan lokasi: " + error.message);
          }
        );
      }

      servers.forEach(function(server) {
        if (server.lat && server.long) {
          L.marker([server.lat, server.long], { icon: serverIcon })
            .addTo(map)
            .bindTooltip("<b>" + server.name + "</b>");
        }
      });

      gateways.forEach((item)=>{
        const itemMarker = L.marker([item.lat, item.long], { icon: odpIcon }, 
        {title: item.name})
        .addTo(map)
        .bindTooltip("<b>" + item.name + "</b>");

        L.polyline([
          [item.parent_lat, item.parent_long],
          [item.lat, item.long]
        ],{ color: "blue" }).addTo(map)
      });

    },
    confirmButtonText: 'Gunakan Lokasi',
    showCancelButton: true,
    cancelButtonText: 'Batal'
  });
}
</script>





{% endblock %}
