{% extends 'index.html' %} {% block content %}

<div class="content-page">
  <div class="form-wrapper column">
    <div class="form-header column">
      <div class="row title-head-td">
        <i
          class="fa-solid fa-clipboard-list"
          style="--clr: var(--clr-fourth); --icon-clr: var(--clr-second)"
        ></i>
        <span class="title">{{ form.instance.pk|yesno:"Edit IP Pool,Buat IP Pool Baru" }}</span>
      </div>
    </div>

    <form method="post" class="column">
      {% csrf_token %}
      <div class="column">
        <label for="name">Server</label>
        {{ form.id_server }}
      </div>
      <div class="column">
        <label for="name">Name</label>
        {{ form.name }}
      </div>
      <div class="column">
        <label for="prefix">Prefix</label>          
        {{ form.prefix }}
      </div>
       <div class="column">
        <label for="count">Jumlah Host</label>
        {{ form.count }}
      </div>
      <div class="column">
        <small id="ip-preview" style="color: #666; font-style: italic;">
          Masukkan prefix dan jumlah host untuk melihat estimasi IP range
        </small>
      </div>
      <div class="row button-wrapper">
        <button class="success-button" type="submit">Simpan</button>
        <button
          class="warning-button no-loader"
          type="button"
          onclick="window.history.back();"
        >
          Batal
        </button>
      </div>
    </form>
  </div>
</div>


{% if success %}
<script>
Swal.fire({
  icon: 'success',
  title: 'Data berhasil disimpan!',
  text: 'Anda akan dialihkan ke halaman Paket.',
  timer: 2000,
  showConfirmButton: false
}).then(() => {
  window.location.href = "{% url 'paket' %}";
});
</script>
{% endif %}

{% if error_message %}
<script>
Swal.fire({
  icon: 'error',
  title: 'Gagal menyimpan!',
  text: '{{ error_message|escapejs }}',
  confirmButtonText: 'OK'
});
</script>
{% endif %}


<script>
  $(document).ready(function() {
    $('#id_id_server').select2({
      placeholder: "Pilih server...",
      allowClear: true
    });
  });
</script>



<script>
document.addEventListener("DOMContentLoaded", function () {
  const prefixInput = document.querySelector("input[name='prefix']");
  const countInput = document.querySelector("input[name='count']");
  const preview = document.getElementById("ip-preview");

  const USABLE_PER_24 = 253;
  const MAX_16 = 256 * USABLE_PER_24; // 64768

  function calculateIpRange(prefix, count) {
    if (!prefix || !count) return "";
    const parts = prefix.split('.').map(s => s.trim()).filter(Boolean);
    const n = Number(count);
    if (!Number.isInteger(n) || n <= 0) return "Jumlah host harus bilangan bulat positif.";

    if (parts.length === 2) {
      if (n > MAX_16) return `Jumlah host terlalu besar untuk prefix ${prefix} (maks ${MAX_16}).`;
      const a = parts[0], b = parts[1];
      const startIp = `${a}.${b}.0.2`;
      const offset = n - 1; // offset dari start
      const third = Math.floor(offset / USABLE_PER_24);
      const fourth = (offset % USABLE_PER_24) + 2;
      if (third > 255) {
        return `Jumlah host terlalu besar untuk prefix ${prefix} (melebihi rentang /16).`;
      }
      const endIp = `${a}.${b}.${third}.${fourth}`;
      return `${startIp} - ${endIp}`;
    } else if (parts.length === 3) {
      const a = parts[0], b = parts[1], c = parts[2];
      if (n > USABLE_PER_24) return `Jumlah host terlalu besar untuk prefix ${prefix} (/24), maks ${USABLE_PER_24}.`;
      const startIp = `${a}.${b}.${c}.2`;
      const endIp = `${a}.${b}.${c}.${n + 1}`;
      return `${startIp} - ${endIp}`;
    } else {
      return "Prefix harus 2 atau 3 oktet (contoh: 10.10 atau 10.10.10).";
    }
  }

  function updatePreview() {
    const prefix = prefixInput.value.trim();
    const count = countInput.value.trim();
    preview.textContent = calculateIpRange(prefix, count);
  }

  prefixInput.addEventListener("input", updatePreview);
  countInput.addEventListener("input", updatePreview);
});
</script>


{% endblock %}
